#!/usr/bin/env bash
set -euo pipefail
set -x
dir="$(realpath -e "$(dirname "$0")")"

# dump env
env

BUILD_DIR="${1-llvm-project/build}"
INSTALL_DIR="${2-$dir/install}"
INSTALL_BINDINGS_DIR="${3-$dir/install-bindings}"

BUILD_LLVM_DEBUG_TARGET="${BUILD_LLVM_DEBUG_TARGET:-}"
BUILD_LLVM_CLEAN_BUILD_DIR="${BUILD_LLVM_CLEAN_BUILD_DIR:-1}"
BUILD_LLVM_CCACHE="${BUILD_LLVM_CCACHE:-0}"
BUILD_LLVM_MLIR_BINDINGS="${BUILD_LLVM_MLIR_BINDINGS:-0}"
BUILD_LLVM_TOOLS="${BUILD_LLVM_TOOLS:-1}"
LLVM_TARGETS_TO_BUILD="${LLVM_TARGETS_TO_BUILD-AArch64;ARM;X86}"

CCACHE_OPTS=""
[ "$BUILD_LLVM_CCACHE" != 1 ] || \
    CCACHE_OPTS="-DLLVM_CCACHE_BUILD=ON -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache"

MLIR_TOOLS="-DLLVM_INCLUDE_TOOLS=ON -DLLVM_BUILD_TOOLS=OFF"
[ "$BUILD_LLVM_TOOLS" != 1 ] || \
    MLIR_TOOLS="-DLLVM_INCLUDE_TOOLS=ON -DLLVM_BUILD_TOOLS=ON"

MLIR_BINDINGS="-DLLVM_INCLUDE_TOOLS=ON -DMLIR_ENABLE_BINDINGS_PYTHON=OFF"
[ "$BUILD_LLVM_MLIR_BINDINGS" != 1 ] || \
    MLIR_BINDINGS="-DLLVM_INCLUDE_TOOLS=ON -DMLIR_ENABLE_BINDINGS_PYTHON=ON"

# Detect if we're in cibuildwheel, in which case we create the /output dir
# to store additional files
[ `pwd` != /project ] || mkdir -p /output

rm -rf "$INSTALL_DIR" "$INSTALL_BINDINGS_DIR"
mkdir -p "$INSTALL_DIR"
mkdir -p "$INSTALL_BINDINGS_DIR"
mkdir -p "$BUILD_DIR"

cd "$BUILD_DIR"
pip3 install -r "$dir"/llvm-project/mlir/python/requirements.txt

#rm -rf "$dir"/install "$dir"/python_bindings/mlir
cmake \
    -DCMAKE_INSTALL_PREFIX="$INSTALL_DIR" \
    -DLLVM_ENABLE_PROJECTS="mlir" \
    -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DLLVM_PARALLEL_LINK_JOBS=1 \
    -DCMAKE_PLATFORM_NO_VERSIONED_SONAME=ON \
    -DLLVM_TARGETS_TO_BUILD="$LLVM_TARGETS_TO_BUILD" \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_BUILD_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_BUILD_EXAMPLES=OFF \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_BUILD_TESTS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DLLVM_BUILD_DOCS=OFF \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DLLVM_INCLUDE_UTILS=OFF \
    -DLLVM_BUILD_UTILS=OFF \
    -DMLIR_INCLUDE_INTEGRATION_TESTS=OFF \
    -DMLIR_INCLUDE_TESTS=OFF \
    -DMLIR_BUILD_MLIR_C_DYLIB=ON \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_ENABLE_SPIRV_CPU_RUNNER=ON \
    $MLIR_TOOLS \
    $MLIR_BINDINGS \
    $CCACHE_OPTS \
    -G Ninja \
    "$dir"/llvm-project/llvm

if [ -z "$BUILD_LLVM_DEBUG_TARGET" ]; then
    ninja
    ninja install
    # remove useless so links
    find "$INSTALL_DIR"/lib/ -type l -name '*.so' | xargs rm -f
    if [ -d "$INSTALL_DIR"/python_packages ]; then
        # Move python bindings
        mv "$INSTALL_DIR"/python_packages/mlir_core/mlir "$INSTALL_BINDINGS_DIR"/
        rm -rf "$INSTALL_DIR"/python_packages
        cp -a "$INSTALL_DIR"/lib/libLLVM.so "$INSTALL_BINDINGS_DIR"/mlir/_mlir_libs/
    fi
else
    ninja $BUILD_LLVM_DEBUG_TARGET
fi

cd "$dir"
[ "$BUILD_LLVM_CLEAN_BUILD_DIR" != 1 ] || rm -rf "$BUILD_DIR"

#    -DCMAKE_VISIBILITY_INLINES_HIDDEN=ON \
#    -DCMAKE_C_VISIBILITY_PRESET=hidden \
#    -DCMAKE_CXX_VISIBILITY_PRESET=hidden \

    # -DLLVM_TOOL_LLVM_DRIVER_BUILD=OFF \
    # -DLLVM_TOOL_LTO_BUILD=OFF \
    # -DLLVM_TOOL_GOLD_BUILD=OFF \
    # -DLLVM_TOOL_LLVM_AR_BUILD=OFF \
    # -DLLVM_TOOL_LLVM_AR_BUILD=OFF \
    # -DLLVM_TOOL_LLVM_LTO_BUILD=OFF \
    # -DLLVM_TOOL_LLVM_PROFDATA_BUILD=OFF \
    # -DLLVM_TOOL_LLD_BUILD=OFF \
    # -DLLVM_TOOL_CLANG_BUILD=OFF \
    # -DLLVM_TOOL_FLANG_BUILD=OFF \
    # -DLLVM_TOOL_LLDB_BUILD=OFF \
    # -DLLVM_TOOL_BOLT_BUILD=OFF \
    # -DLLVM_TOOL_POLLY_BUILD=OFF \
    # -DLLVM_TOOL_LIBCLC_BUILD=OFF \
    # -DLLVM_TOOL_LLVM_CONFIG_BUILD=ON \
    # -DLLVM_TOOL_MLIR_BUILD=ON \
