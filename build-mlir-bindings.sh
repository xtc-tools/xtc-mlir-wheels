#!/usr/bin/env bash
set -euo pipefail
set -x
dir="$(realpath -e "$(dirname "$0")")"

# dump env
env

BUILD_DIR="${1-llvm-project/build}"
INSTALL_DIR="${2-$dir/install}"
INSTALL_BINDINGS_DIR="${3-$dir/install-bindings}"

BUILD_LLVM_DEBUG_TARGET="${BUILD_LLVM_DEBUG_TARGET:-}"
BUILD_LLVM_CLEAN_BUILD_DIR="${BUILD_LLVM_CLEAN_BUILD_DIR:-1}"
BUILD_LLVM_CCACHE="${BUILD_LLVM_CCACHE:-0}"
BUILD_LLVM_MLIR_BINDINGS="${BUILD_LLVM_MLIR_BINDINGS:-0}"
BUILD_LLVM_TOOLS="${BUILD_LLVM_TOOLS:-1}"
LLVM_TARGETS_TO_BUILD="${LLVM_TARGETS_TO_BUILD-AArch64;ARM;X86}"
BUILD_LLVM_COMPONENTS="${BUILD_LLVM_COMPONENTS-}"

LLVM_BUILD_TYPE="Release" # "MinSizeRel"

CCACHE_OPTS=""
[ "$BUILD_LLVM_CCACHE" != 1 ] || \
    CCACHE_OPTS="-DLLVM_CCACHE_BUILD=ON -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache"

if [ "$BUILD_LLVM_TOOLS" = 1 ]; then
    MLIR_TOOLS="-DLLVM_INCLUDE_TOOLS=ON -DLLVM_BUILD_TOOLS=ON -DLLVM_INCLUDE_UTILS=ON -DLLVM_BUILD_UTILS=ON -DLLVM_INSTALL_TOOLCHAIN_ONLY=OFF"
else
    MLIR_TOOLS="-DLLVM_INCLUDE_TOOLS=ON -DLLVM_BUILD_TOOLS=OFF -DLLVM_INCLUDE_UTILS=OFF -DLLVM_BUILD_UTILS=OFF -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON"
fi

if [ "$BUILD_LLVM_MLIR_BINDINGS" = 1 ]; then
    MLIR_BINDINGS="-DLLVM_INCLUDE_TOOLS=ON -DMLIR_ENABLE_BINDINGS_PYTHON=ON"
else
    MLIR_BINDINGS="-DLLVM_INCLUDE_TOOLS=ON -DMLIR_ENABLE_BINDINGS_PYTHON=OFF"
fi

COMPONENTS=""
if [ "$BUILD_LLVM_COMPONENTS" != "" ]; then
    COMPONENTS_FILE="$dir/components_$BUILD_LLVM_COMPONENTS.txt"
    if [ -f "$COMPONENTS_FILE" ]; then
        LLVM_DISTRIBUTION_COMPONENTS="$(cat "$COMPONENTS_FILE" | tr '\n' ';')"
    else
        LLVM_DISTRIBUTION_COMPONENTS="$BUILD_LLVM_COMPONENTS"
    fi
    COMPONENTS="-DLLVM_DISTRIBUTION_COMPONENTS=$LLVM_DISTRIBUTION_COMPONENTS"
fi

[ "$BUILD_LLVM_CLEAN_BUILD_DIR" != 1 ] || rm -rf "$BUILD_DIR"
rm -rf "$INSTALL_DIR" "$INSTALL_BINDINGS_DIR"
mkdir -p "$INSTALL_DIR"
mkdir -p "$INSTALL_BINDINGS_DIR"
mkdir -p "$BUILD_DIR"

cd "$BUILD_DIR"

pip3 install -r "$dir"/llvm-project/mlir/python/requirements.txt
pip list

#rm -rf "$dir"/install "$dir"/python_bindings/mlir
cmake \
    -DCMAKE_INSTALL_PREFIX="$INSTALL_DIR" \
    -DLLVM_ENABLE_PROJECTS="mlir" \
    -DCMAKE_BUILD_TYPE="$LLVM_BUILD_TYPE" \
    -DLLVM_ENABLE_WARNINGS=OFF \
    -DLLVM_PARALLEL_LINK_JOBS=1 \
    -DCMAKE_PLATFORM_NO_VERSIONED_SONAME=ON \
    -DLLVM_TARGETS_TO_BUILD="$LLVM_TARGETS_TO_BUILD" \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DLLVM_BUILD_BENCHMARKS=OFF \
    -DLLVM_INCLUDE_EXAMPLES=OFF \
    -DLLVM_BUILD_EXAMPLES=OFF \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_BUILD_TESTS=OFF \
    -DLLVM_INCLUDE_DOCS=OFF \
    -DLLVM_BUILD_DOCS=OFF \
    -DLLVM_BUILD_LLVM_DYLIB=ON \
    -DLLVM_LINK_LLVM_DYLIB=ON \
    -DMLIR_INCLUDE_INTEGRATION_TESTS=OFF \
    -DMLIR_INCLUDE_TESTS=OFF \
    -DMLIR_LINK_MLIR_DYLIB=ON \
    -DMLIR_BUILD_MLIR_C_DYLIB=ON \
    -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
    -DMLIR_ENABLE_SPIRV_CPU_RUNNER=ON \
    $MLIR_TOOLS \
    $MLIR_BINDINGS \
    $COMPONENTS \
    $CCACHE_OPTS \
    -Wno-dev \
    -Wno-deprecated \
    -G Ninja \
    "$dir"/llvm-project/llvm

if [ -z "$BUILD_LLVM_DEBUG_TARGET" ]; then
    if [ "$BUILD_LLVM_COMPONENTS" != "" ]; then
        ninja distribution
        ninja install-distribution
        case "$BUILD_LLVM_COMPONENTS" in
            bins) rm -rf "$INSTALL_DIR"/include "$INSTALL_DIR"/lib/*.a "$INSTALL_DIR"/lib/objects-* ;;
        esac
    else
        ninja
        ninja install
    fi
    if [ -d "$INSTALL_DIR"/lib ]; then
        # remove useless so links
        find "$INSTALL_DIR"/lib/ -type l -name '*.so' | xargs rm -f
    fi
    if [ -d "$INSTALL_DIR"/python_packages ]; then
        # Move python bindings
        mv "$INSTALL_DIR"/python_packages/mlir_core/mlir "$INSTALL_BINDINGS_DIR"/
        rm -rf "$INSTALL_DIR"/python_packages
        cp -a "$INSTALL_DIR"/lib/libLLVM.so "$INSTALL_BINDINGS_DIR"/mlir/_mlir_libs/
    fi
else
    ninja $BUILD_LLVM_DEBUG_TARGET
fi

cd "$dir"
[ "$BUILD_LLVM_CLEAN_BUILD_DIR" != 1 ] || rm -rf "$BUILD_DIR"


#    -DCMAKE_VISIBILITY_INLINES_HIDDEN=ON \
    #    -DCMAKE_C_VISIBILITY_PRESET=hidden \
    #    -DCMAKE_CXX_VISIBILITY_PRESET=hidden \

# -DLLVM_TOOL_LLVM_DRIVER_BUILD=OFF \
    # -DLLVM_TOOL_LTO_BUILD=OFF \
    # -DLLVM_TOOL_GOLD_BUILD=OFF \
    # -DLLVM_TOOL_LLVM_AR_BUILD=OFF \
    # -DLLVM_TOOL_LLVM_AR_BUILD=OFF \
    # -DLLVM_TOOL_LLVM_LTO_BUILD=OFF \
    # -DLLVM_TOOL_LLVM_PROFDATA_BUILD=OFF \
    # -DLLVM_TOOL_LLD_BUILD=OFF \
    # -DLLVM_TOOL_CLANG_BUILD=OFF \
    # -DLLVM_TOOL_FLANG_BUILD=OFF \
    # -DLLVM_TOOL_LLDB_BUILD=OFF \
    # -DLLVM_TOOL_BOLT_BUILD=OFF \
    # -DLLVM_TOOL_POLLY_BUILD=OFF \
    # -DLLVM_TOOL_LIBCLC_BUILD=OFF \
    # -DLLVM_TOOL_LLVM_CONFIG_BUILD=ON \
    # -DLLVM_TOOL_MLIR_BUILD=ON \
